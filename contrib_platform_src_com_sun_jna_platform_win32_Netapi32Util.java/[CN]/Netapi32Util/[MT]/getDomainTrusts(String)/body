{
  IntByReference domainCount=new IntByReference();
  PointerByReference domainsPointerRef=new PointerByReference();
  int rc=Netapi32.INSTANCE.DsEnumerateDomainTrusts(serverName,DsGetDC.DS_DOMAIN_VALID_FLAGS,domainsPointerRef,domainCount);
  if (W32Errors.NO_ERROR != rc) {
    throw new Win32Exception(rc);
  }
  try {
    DS_DOMAIN_TRUSTS domains=new DS_DOMAIN_TRUSTS(domainsPointerRef.getValue());
    int domainCountValue=domainCount.getValue();
    ArrayList<DomainTrust> trusts=new ArrayList<DomainTrust>(domainCountValue);
    for (    DS_DOMAIN_TRUSTS trust : (DS_DOMAIN_TRUSTS[])domains.toArray(new DS_DOMAIN_TRUSTS[domainCountValue])) {
      DomainTrust t=new DomainTrust();
      if (trust.DnsDomainName != null) {
        t.DnsDomainName=trust.DnsDomainName.toString();
      }
      if (trust.NetbiosDomainName != null) {
        t.NetbiosDomainName=trust.NetbiosDomainName.toString();
      }
      t.DomainSid=trust.DomainSid;
      if (trust.DomainSid != null) {
        t.DomainSidString=Advapi32Util.convertSidToStringSid(trust.DomainSid);
      }
      t.DomainGuid=trust.DomainGuid;
      if (trust.DomainGuid != null) {
        t.DomainGuidString=Ole32Util.getStringFromGUID(trust.DomainGuid);
      }
      t.flags=trust.Flags;
      trusts.add(t);
    }
    return trusts.toArray(new DomainTrust[0]);
  }
  finally {
    rc=Netapi32.INSTANCE.NetApiBufferFree(domainsPointerRef.getValue());
    if (W32Errors.NO_ERROR != rc) {
      throw new Win32Exception(rc);
    }
  }
}
