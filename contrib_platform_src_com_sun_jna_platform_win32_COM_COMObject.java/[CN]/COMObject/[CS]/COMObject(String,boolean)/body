{
  HRESULT hr=Ole32.INSTANCE.CoInitializeEx(null,Ole32.COINIT_MULTITHREADED);
  if (COMUtils.FAILED(hr)) {
    this.release();
    throw new COMException("CoInitializeEx() failed: " + Kernel32Util.formatMessage(hr));
  }
  CLSID clsid=new CLSID();
  hr=Ole32.INSTANCE.CLSIDFromProgID(progId,clsid);
  if (COMUtils.FAILED(hr)) {
    Ole32.INSTANCE.CoUninitialize();
    throw new COMException("CLSIDFromProgID() failed: " + Kernel32Util.formatMessage(hr));
  }
  if (useActiveInstance) {
    hr=OleAuto.INSTANCE.GetActiveObject(clsid,null,this.pUnknown);
    if (COMUtils.SUCCEEDED(hr)) {
      this.iUnknown=new IUnknown(this.pUnknown.getValue());
      hr=iUnknown.QueryInterface(IDispatch.IID_IDispatch,this.pDispatch);
    }
 else {
      hr=Ole32.INSTANCE.CoCreateInstance(clsid,null,WTypes.CLSCTX_SERVER,IDispatch.IID_IDispatch,this.pDispatch);
    }
  }
 else {
    hr=Ole32.INSTANCE.CoCreateInstance(clsid,null,WTypes.CLSCTX_SERVER,IDispatch.IID_IDispatch,this.pDispatch);
  }
  if (COMUtils.FAILED(hr)) {
    throw new COMException("COM object with ProgID '" + progId + "' and CLSID "+ clsid.toGuidString()+ " not registered properly!");
  }
  this.iDispatch=new IDispatch(this.pDispatch.getValue());
}
