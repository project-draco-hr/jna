{
  Pointer fp=null;
  if (cb == null) {
    return null;
  }
  if ((fp=getNativeFunctionPointer(cb)) != null) {
    return fp;
  }
  int callingConvention=cb instanceof AltCallingConvention ? Function.ALT_CONVENTION : Function.C_CONVENTION;
  Map map=callbackMap;
synchronized (map) {
    CallbackReference cbref=(CallbackReference)map.get(cb);
    if (cbref == null) {
      cbref=new CallbackReference(cb,callingConvention,direct);
      map.put(cb,cbref);
      if (initializers.containsKey(cb)) {
        cbref.setCallbackOptions(Native.CB_HAS_INITIALIZER);
      }
    }
    return cbref.getTrampoline();
  }
}
