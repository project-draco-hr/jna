{
class TestTypeMapper extends DefaultTypeMapper {
{
      TypeConverter tc=new TypeConverter(){
        public Class nativeType(){
          return int.class;
        }
        public Object fromNative(        Object nativeValue,        FromNativeContext c){
          return new Boolean(nativeValue.equals(new Integer(0)));
        }
        public Object toNative(        Object value,        ToNativeContext c){
          return new Integer(Boolean.TRUE.equals(value) ? -1 : 0);
        }
      }
;
      addTypeConverter(boolean.class,tc);
      addTypeConverter(Boolean.class,tc);
    }
  }
  final TestTypeMapper m=new TestTypeMapper();
class TestStructure extends Structure {
    public boolean field;
    protected List getFieldOrder(){
      return Arrays.asList(new String[]{"field"});
    }
    public TestStructure(){
      setTypeMapper(m);
    }
    public TestStructure(    TypeMapper m){
      super(m);
    }
  }
  Structure ts=new TestStructure();
  Structure ts2=new TestStructure();
  Structure ts3=new TestStructure(m);
  assertSame("Structure layout should be cached with custom type mapper",ts.fields(),ts2.fields());
  assertSame("Structure layout should be cached with custom type mapper, regardless of when set",ts.fields(),ts3.fields());
}
