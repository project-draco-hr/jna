{
  NativeLibrary lib=NativeLibrary.getInstance("testlib");
  WeakReference ref=new WeakReference(lib);
  Function f=lib.getFunction("callCount");
  lib=null;
  System.gc();
  long start=System.currentTimeMillis();
  while (ref.get() != null && System.currentTimeMillis() - start < 2000) {
    Thread.sleep(10);
  }
  assertNotNull("Library GC'd when it should not be",ref.get());
  f.invokeInt(new Object[0]);
  f=null;
  System.gc();
  while (ref.get() != null && System.currentTimeMillis() - start < 5000) {
    Thread.sleep(10);
  }
  assertNull("Library not GC'd",ref.get());
}
