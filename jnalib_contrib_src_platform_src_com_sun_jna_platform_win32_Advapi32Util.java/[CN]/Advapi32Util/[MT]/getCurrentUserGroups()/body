{
  HANDLEByReference phToken=new HANDLEByReference();
  try {
    HANDLE threadHandle=Kernel32.INSTANCE.GetCurrentThread();
    if (!Advapi32.INSTANCE.OpenThreadToken(threadHandle,WinNT.TOKEN_DUPLICATE | WinNT.TOKEN_QUERY,true,phToken)) {
      if (W32Errors.ERROR_NO_TOKEN != Kernel32.INSTANCE.GetLastError()) {
        throw new LastErrorException(Kernel32.INSTANCE.GetLastError());
      }
      HANDLE processHandle=Kernel32.INSTANCE.GetCurrentProcess();
      if (!Advapi32.INSTANCE.OpenProcessToken(processHandle,WinNT.TOKEN_DUPLICATE | WinNT.TOKEN_QUERY,phToken)) {
        throw new LastErrorException(Kernel32.INSTANCE.GetLastError());
      }
    }
    return getTokenGroups(phToken.getValue());
  }
  finally {
    if (phToken.getValue() != Kernel32.INVALID_HANDLE_VALUE) {
      if (!Kernel32.INSTANCE.CloseHandle(phToken.getValue())) {
        throw new LastErrorException(Kernel32.INSTANCE.GetLastError());
      }
    }
  }
}
