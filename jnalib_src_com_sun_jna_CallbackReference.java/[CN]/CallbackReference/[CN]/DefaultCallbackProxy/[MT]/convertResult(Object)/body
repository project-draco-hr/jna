{
  if (toNative != null) {
    value=toNative.toNative(value,new CallbackResultContext(callbackMethod));
  }
  if (value == null)   return null;
  Class cls=value.getClass();
  if (Structure.class.isAssignableFrom(cls)) {
    if (Structure.ByValue.class.isAssignableFrom(cls)) {
      return value;
    }
    return ((Structure)value).getPointer();
  }
 else   if (cls == boolean.class || cls == Boolean.class) {
    return new Integer(Boolean.TRUE.equals(value) ? -1 : 0);
  }
 else   if (cls == String.class || cls == WString.class) {
    NativeString ns=new NativeString(value.toString(),cls == WString.class);
    nativeStrings.put(value,ns);
    return ns.getPointer();
  }
 else   if (Callback.class.isAssignableFrom(cls)) {
    return getFunctionPointer((Callback)value);
  }
  return value;
}
