{
  super(callback);
  Class type=callback.getClass();
  Class[] ifaces=type.getInterfaces();
  for (int i=0; i < ifaces.length; i++) {
    if (Callback.class.isAssignableFrom(ifaces[i])) {
      type=ifaces[i];
      break;
    }
  }
  TypeMapper mapper=null;
  Class declaring=type.getDeclaringClass();
  if (declaring != null) {
    mapper=Native.getTypeMapper(declaring);
  }
  Method m=getCallbackMethod(callback);
  if (callback instanceof CallbackProxy) {
    proxy=(CallbackProxy)callback;
  }
 else {
    proxy=new DefaultCallbackProxy(m,mapper);
  }
  Class[] nativeParamTypes=proxy.getParameterTypes();
  Class returnType=proxy.getReturnType();
  if (mapper != null) {
    for (int i=0; i < nativeParamTypes.length; i++) {
      FromNativeConverter rc=mapper.getFromNativeConverter(nativeParamTypes[i]);
      if (rc != null) {
        nativeParamTypes[i]=rc.nativeType();
      }
    }
    ToNativeConverter tn=mapper.getToNativeConverter(returnType);
    if (tn != null) {
      returnType=tn.nativeType();
    }
  }
  for (int i=0; i < nativeParamTypes.length; i++) {
    nativeParamTypes[i]=getNativeType(nativeParamTypes[i]);
    if (!isAllowableNativeType(nativeParamTypes[i])) {
      String msg="Callback argument " + nativeParamTypes[i] + " requires custom type conversion";
      throw new IllegalArgumentException(msg);
    }
  }
  returnType=getNativeType(returnType);
  if (!isAllowableNativeType(returnType)) {
    String msg="Callback return type " + returnType + " requires custom type conversion";
    throw new IllegalArgumentException(msg);
  }
  Method proxyMethod=getCallbackMethod(proxy);
  cbstruct=createNativeCallback(proxy,proxyMethod,nativeParamTypes,returnType,callingConvention);
}
