{
  libOptions=new HashMap(libOptions);
  libOptions.put(_OPTION_ENCLOSING_LIBRARY,cls);
synchronized (libraries) {
    options.put(cls,libOptions);
    if (proxy != null) {
      libraries.put(cls,new WeakReference(proxy));
    }
    if (!cls.isInterface() && Library.class.isAssignableFrom(cls)) {
      Class ifaces[]=cls.getInterfaces();
      for (int i=0; i < ifaces.length; i++) {
        if (Library.class.isAssignableFrom(ifaces[i])) {
          cacheOptions(ifaces[i],libOptions,proxy);
          break;
        }
      }
    }
  }
  return libOptions;
}
