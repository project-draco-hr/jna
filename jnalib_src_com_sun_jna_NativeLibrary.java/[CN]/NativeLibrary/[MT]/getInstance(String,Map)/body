{
  options=new HashMap(options);
  if (options.get(Library.OPTION_CALLING_CONVENTION) == null) {
    options.put(Library.OPTION_CALLING_CONVENTION,new Integer(Function.C_CONVENTION));
  }
synchronized (libraries) {
    WeakReference ref=(WeakReference)libraries.get(libraryName + options);
    NativeLibrary library=ref != null ? (NativeLibrary)ref.get() : null;
    if (library == null) {
      if (libraryName == null) {
        library=new NativeLibrary("<process>",null,open(null),options);
      }
 else {
        library=loadLibrary(libraryName,options);
      }
      ref=new WeakReference(library);
      libraries.put(library.getName() + options,ref);
      File file=library.getFile();
      if (file != null) {
        libraries.put(file.getAbsolutePath() + options,ref);
        libraries.put(file.getName() + options,ref);
      }
    }
    return library;
  }
}
