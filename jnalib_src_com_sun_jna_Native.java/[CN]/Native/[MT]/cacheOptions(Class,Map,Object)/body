{
synchronized (libraries) {
    if (!libOptions.isEmpty())     options.put(cls,libOptions);
    if (libOptions.containsKey(Library.OPTION_TYPE_MAPPER))     typeMappers.put(cls,libOptions.get(Library.OPTION_TYPE_MAPPER));
    if (libOptions.containsKey(Library.OPTION_STRUCTURE_ALIGNMENT))     alignments.put(cls,libOptions.get(Library.OPTION_STRUCTURE_ALIGNMENT));
    if (proxy != null) {
      libraries.put(cls,new WeakReference(proxy));
    }
    if (!cls.isInterface() && Library.class.isAssignableFrom(cls)) {
      Class ifaces[]=cls.getInterfaces();
      for (int i=0; i < ifaces.length; i++) {
        if (Library.class.isAssignableFrom(ifaces[i])) {
          cacheOptions(ifaces[i],libOptions,proxy);
          break;
        }
      }
    }
  }
}
