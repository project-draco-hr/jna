{
  int offset=structField.offset;
  Object value=getField(structField);
  Class nativeType=structField.type;
  ToNativeConverter converter=structField.writeConverter;
  if (converter != null) {
    value=converter.toNative(value,new StructureWriteContext(this,structField.field));
    nativeType=converter.nativeType();
  }
  if (String.class == nativeType || WString.class == nativeType) {
    boolean wide=nativeType == WString.class;
    if (value != null) {
      NativeString nativeString=new NativeString(value.toString(),wide);
      nativeStrings.put(structField.name,nativeString);
      value=nativeString.getPointer();
    }
 else {
      value=null;
      nativeStrings.remove(structField.name);
    }
  }
  if (!writeValue(offset,value,nativeType)) {
    String msg="Structure field \"" + structField.name + "\" was declared as "+ structField.type+ (structField.type == nativeType ? "" : " (native type " + nativeType + ")")+ ", which is not supported within a Structure";
    throw new IllegalArgumentException(msg);
  }
}
